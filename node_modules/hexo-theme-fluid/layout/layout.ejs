<%
var banner_img_height = parseFloat(page.banner_img_height || theme.index.banner_img_height)
var colorSchema = theme.dark_mode && theme.dark_mode.enable && theme.dark_mode.default ? theme.dark_mode.default : ''
%>

<!DOCTYPE html>
<html lang="<%= config.language %>" <%= colorSchema ? `data-default-color-scheme=${colorSchema}` : '' %>>

<%- partial('_partials/head.ejs') %>

<!-- 引入 LeanCloud SDK -->
<script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.15.0/dist/av-min.js"></script>

<body>
  <%- inject_point('bodyBegin') %>

  <header>
    <%- inject_point('header') %>
  </header>

  <main>
    <% if(is_post() || page.layout === '404') { %>
      <%- body %>
      <!-- 添加点赞按钮 -->
      <div class="like-container">
        <button class="like-btn">点赞</button>
        <span class="like-count">0</span>
      </div>
    <% } else { %>
      <div class="container nopadding-x-md">
        <div id="board"
          <%- banner_img_height >= 100 && theme.banner && theme.banner.parallax ? 'style="margin-top: 0"' : '' %>>
          <% if(page.layout === 'about') { %>
            <div class="about-avatar">
              <img src="<%= url_for(theme.about.avatar) %>" class="img-fluid" alt="avatar">
            </div>
          <% } %>
          <div class="container">
            <div class="row">
              <div class="col-12 col-md-10 m-auto">
                <%- body %>
              </div>
            </div>
          </div>
        </div>
      </div>
    <% } %>

    <% if (theme.scroll_top_arrow.enable) { %>
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    <% } %>

    <% if (theme.search.enable) { %>
      <%- partial('_partials/search.ejs') %>
    <% } %>

    <% if (theme.custom_html) { %>
      <div class="col-lg-7 mx-auto nopadding-x-md">
        <div class="container custom mx-auto">
          <%- theme.custom_html %>
        </div>
      </div>
    <% } %>
  </main>

  <footer>
    <%- inject_point('footer') %>
  </footer>

  <!-- Scripts -->
  <%- partial('_partials/scripts.ejs') %>

  <!-- 添加点赞功能的 JavaScript 代码 -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
        const likeBtn = document.querySelector('.like-btn');
        if (likeBtn) {
            // 初始化 LeanCloud
            const APP_ID = 'xX3VwKU8zGdlW2X9iVfKNQh2-gzGzoHsz';
            const APP_KEY = 'MJ8GqCzNhjprX3lHwsPehH61';
            const SERVER_URL = 'https://xx3vwku8.lc-cn-n1-shared.com';

            AV.init({
                appId: APP_ID,
                appKey: APP_KEY,
                serverURLs: SERVER_URL
            });

            // 获取当前文章的唯一标识，这里假设使用文章的路径作为标识
            const postPath = window.location.pathname;

            // 查询当前文章的点赞数
            const query = new AV.Query('BlogLike');
            query.equalTo('postPath', postPath);
            query.first().then((result) => {
                if (result) {
                    const likeCount = result.get('likeCount');
                    const likeCountElement = document.querySelector('.like-count');
                    if (likeCountElement) {
                        likeCountElement.textContent = likeCount;
                    }
                } else {
                    // 如果记录不存在，创建新记录
                    const BlogLike = AV.Object.extend('BlogLike');
                    const blogLike = new BlogLike();
                    blogLike.set('postPath', postPath);
                    blogLike.set('likeCount', 0);
                    blogLike.save().then(() => {
                        const likeCountElement = document.querySelector('.like-count');
                        if (likeCountElement) {
                            likeCountElement.textContent = 0;
                        }
                    }).catch((error) => {
                        console.error('创建点赞记录失败:', error);
                        alert('创建点赞记录失败，请稍后重试！');
                    });
                }
            }).catch((error) => {
                console.error('查询点赞数失败:', error);
                alert('查询点赞数失败，请稍后重试！');
            });

            likeBtn.addEventListener('click', function() {
                // 假设用户已经登录，获取当前用户
                const currentUser = AV.User.current();
                if (currentUser) {
                    const userQuery = new AV.Query('UserLikeCount');
                    userQuery.equalTo('user', currentUser);
                    userQuery.first().then((userResult) => {
                        if (userResult) {
                            const userLikeCount = userResult.get('likeCount');
                            if (userLikeCount >= 100) {
                                alert('你已经达到点赞上限！');
                                return;
                            }
                        }
                        this.classList.toggle('liked');
                        // 点击时更新点赞数
                        const query = new AV.Query('BlogLike');
                        query.equalTo('postPath', postPath);
                        query.first().then((result) => {
                            if (result) {
                                const likeCount = result.get('likeCount');
                                result.set('likeCount', likeCount + 1);
                                result.save().then(() => {
                                    console.log('点赞成功');
                                    const likeCountElement = document.querySelector('.like-count');
                                    if (likeCountElement) {
                                        likeCountElement.textContent = likeCount + 1;
                                    }
                                    // 更新用户点赞数
                                    if (userResult) {
                                        userResult.set('likeCount', userLikeCount + 1);
                                        userResult.save().catch((error) => {
                                            console.error('更新用户点赞数失败:', error);
                                            alert('更新用户点赞数失败，请稍后重试！');
                                        });
                                    } else {
                                        const UserLikeCount = AV.Object.extend('UserLikeCount');
                                        const userLikeCountObj = new UserLikeCount();
                                        userLikeCountObj.set('user', currentUser);
                                        userLikeCountObj.set('likeCount', 1);
                                        userLikeCountObj.save().catch((error) => {
                                            console.error('创建用户点赞记录失败:', error);
                                            alert('创建用户点赞记录失败，请稍后重试！');
                                        });
                                    }
                                }).catch((error) => {
                                    console.error('更新点赞数失败:', error);
                                    alert('更新点赞数失败，请稍后重试！');
                                });
                            }
                        }).catch((error) => {
                            console.error('查询点赞数失败:', error);
                            alert('查询点赞数失败，请稍后重试！');
                        });
                    }).catch((error) => {
                        console.error('查询用户点赞次数失败:', error);
                        alert('查询用户点赞次数失败，请稍后重试！');
                    });
                } else {
                    alert('请先登录再进行点赞操作！');
                }
            });
        }
    });
  </script>

  <%- inject_point('bodyEnd') %>

  <noscript>
    <div class="noscript-warning"><%- __('noscript_warning') %></div>
  </noscript>
</body>
</html>
