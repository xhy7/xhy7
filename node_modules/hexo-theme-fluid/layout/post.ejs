<%
page.banner_img = page.banner_img || theme.post.banner_img
page.banner_img_height = page.banner_img_height || theme.post.banner_img_height
page.banner_mask_alpha = page.banner_mask_alpha || theme.post.banner_mask_alpha
%>

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      <%- inject_point('postLeft') %>
    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header"><%= page.subtitle || page.title %></h1>
            <% if (theme.post.updated.enable && theme.post.updated && compare_date(page.date, page.updated)) { %>
              <p id="updated-time" class="note note-<%= theme.post.updated.note_class || 'info' %>" style="<%= theme.post.updated.relative ? 'display: none' : '' %>">
                <% if (theme.post.updated.relative) { %>
                  <% if (theme.post.updated.content) { %>
                    <!-- compatible with older versions-->
                    <%- theme.post.updated.content %><%- date(page.updated, 'YYYY-MM-DDTHH:mm:ssZ') %>
                  <% } else { %>
                    <%- __('post.updated', date(page.updated, 'YYYY-MM-DDTHH:mm:ssZ')) %>
                  <% } %>
                  <%- partial('_partials/plugins/moment.ejs') %>
                <% } else { %>
                  <% if (theme.post.updated.content) { %>
                    <!-- compatible with older versions-->
                    <%- theme.post.updated.content %><%- date(page.updated, theme.post.updated.date_format) %>
                  <% } else { %>
                    <%- __('post.updated', date(page.updated, theme.post.updated.date_format)) %>
                  <% } %>
                <% } %>
              </p>
            <% } %>
            <% if (page.encrypt === true) { %>
              <%- inject_point('postMarkdownBegin') %>
              <%- page.content %>
              <%- partial('_partials/plugins/encrypt') %>
              <%- inject_point('postMarkdownEnd') %>
            <% } else { %>
              <div class="markdown-body">
                <%- inject_point('postMarkdownBegin') %>
                <%- page.content %>
                <%- inject_point('postMarkdownEnd') %>
              </div>
              <div id="zan" class="clearfix" style="margin: 30px 0">
                <div class="heart" onclick="goodplus(url, flag)"></div>
                <div id="zan_text"></div>
              </div>
            <% } %>
            <hr/>
            <div>
              <%- inject_point('postMetaBottom') %>

              <%- inject_point('postCopyright') %>

              <% if (theme.post.prev_next.enable && !page.hide) { %>
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    <% const prev = prev_post(page) %>
                    <% if (prev) { %>
                      <a href="<%= url_for(prev.path) %>" title="<%= prev.title %>">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile"><%= prev.title %></span>
                        <span class="visible-mobile"><%- __('post.prev_post') %></span>
                      </a>
                    <% } %>
                  </article>
                  <article class="post-next col-6">
                    <% const next = next_post(page) %>
                    <% if (next) { %>
                      <a href="<%= url_for(next.path) %>" title="<%= next.title %>">
                        <span class="hidden-mobile"><%= next.title %></span>
                        <span class="visible-mobile"><%- __('post.next_post') %></span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    <% } %>
                  </article>
                </div>
              <% } %>
            </div>

            <%- inject_point('postComments') %>
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      <%- inject_point('postRight') %>
    </div>
  </div>
</div>

<%- partial('_partials/markdown-plugins') %>

<!-- 点赞按钮 -->
<div class="like-button" data-article-id="<%= post.slug %>">
  <button id="like-btn" class="like-btn">
    <i class="fas fa-thumbs-up"></i> 点赞 (<span id="like-count">0</span>)
  </button>
</div>

<!-- LeanCloud SDK 及点赞逻辑 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/leancloud-storage/4.15.0/av-min.js"></script>
<script>
  // 初始化 LeanCloud
  AV.init({
    appId: '你的 LeanCloud App ID',
    appKey: '你的 LeanCloud App Key',
    serverURL: 'https://你的 LeanCloud 应用域名/1.1' // 格式：https://<app-id>.api.lncldglobal.com
  });

  const articleId = document.querySelector('.like-button').dataset.articleId;
  const likeBtn = document.getElementById('like-btn');
  const likeCount = document.getElementById('like-count');

  // 加载初始点赞数
  function loadLikeCount() {
    const query = new AV.Query('Like');
    query.equalTo('articleId', articleId);
    query.find().then(res => {
      if (res.length > 0) {
        likeCount.textContent = res[0].get('likeCount');
      } else {
        // 初始化记录
        const like = new AV.Object('Like');
        like.set('articleId', articleId);
        like.set('likeCount', 0);
        like.save();
        likeCount.textContent = 0;
      }
    });
  }

  // 处理点赞点击
  likeBtn.addEventListener('click', () => {
    const query = new AV.Query('Like');
    query.equalTo('articleId', articleId);
    query.find().then(res => {
      let likeObj;
      if (res.length > 0) {
        likeObj = res[0];
      } else {
        likeObj = new AV.Object('Like');
        likeObj.set('articleId', articleId);
      }
      // 点赞数 +1
      likeObj.increment('likeCount', 1);
      likeObj.save().then(() => {
        likeCount.textContent = likeObj.get('likeCount');
        // 按钮样式变化（可选）
        likeBtn.classList.add('liked');
        likeBtn.innerHTML = '<i class="fas fa-thumbs-up"></i> 已点赞';
      });
    });
  });

  // 页面加载时初始化
  document.addEventListener('DOMContentLoaded', loadLikeCount);
</script>

<% if(theme.post.custom && theme.post.custom.enable && theme.post.custom.content && page.custom !== false) { %>
  <!-- Custom -->
  <div class="col-lg-7 mx-auto nopadding-x-md">
    <div class="container custom post-custom mx-auto">
      <%- page.custom || theme.post.custom.content %>
    </div>
  </div>
<% } %>
